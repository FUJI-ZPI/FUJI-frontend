import React, { useState, useCallback } from "react";
import { View, StyleSheet, TouchableOpacity, Text, Dimensions } from "react-native";
import { PanGestureHandler, GestureHandlerRootView, State } from "react-native-gesture-handler";
import Svg, { Path } from "react-native-svg";
import * as SecureStore from 'expo-secure-store';

const { width } = Dimensions.get("window");
const CANVAS_SIZE = 256;
 
type Point = { x: number; y: number };

type KanjiAccuracyResult = {
  overallAccuracy: number;
  strokeAccuracies: number[];
};

type Stroke = {
  points: number[][];
  accuracy?: number;
};


const REFERENCE_KANJI_POINTS: Point[][] = [
  [
    { x: 141.61702127659575, y: 12.709219858156033 },
    { x: 139.80141843971631, y: 12.709219858156033 },
    { x: 137.98581560283688, y: 12.709219858156033 },
    { x: 137.98581560283688, y: 14.524822695035464 },
    { x: 136.17021276595744, y: 16.340425531914896 },
    { x: 134.354609929078, y: 18.15602836879433 },
    { x: 134.354609929078, y: 19.971631205673763 },
    { x: 132.53900709219857, y: 21.787234042553195 },
    { x: 132.53900709219857, y: 23.60283687943263 },
    { x: 130.72340425531914, y: 25.41843971631206 },
    { x: 128.9078014184397, y: 29.049645390070925 },
    { x: 128.9078014184397, y: 30.865248226950357 },
    { x: 127.09219858156028, y: 30.865248226950357 },
    { x: 127.09219858156028, y: 34.49645390070923 },
    { x: 125.27659574468085, y: 36.312056737588655 },
    { x: 123.46099290780141, y: 38.12765957446809 },
    { x: 123.46099290780141, y: 39.94326241134752 },
    { x: 121.64539007092198, y: 41.758865248226954 },
    { x: 119.82978723404256, y: 43.57446808510639 },
    { x: 119.82978723404256, y: 45.39007092198582 },
    { x: 119.82978723404256, y: 47.20567375886525 },
    { x: 118.01418439716312, y: 47.20567375886525 },
    { x: 118.01418439716312, y: 49.02127659574468 },
    { x: 116.19858156028369, y: 50.836879432624116 },
    { x: 114.38297872340425, y: 52.65248226950355 },
    { x: 112.56737588652481, y: 54.46808510638298 },
    { x: 110.7517730496454, y: 56.283687943262414 },
    { x: 108.93617021276596, y: 59.91489361702128 },
    { x: 107.12056737588652, y: 59.91489361702128 },
    { x: 107.12056737588652, y: 61.73049645390071 },
    { x: 105.30496453900709, y: 61.73049645390071 },
    { x: 103.48936170212765, y: 63.54609929078015 },
    { x: 101.67375886524823, y: 65.36170212765958 },
    { x: 101.67375886524823, y: 67.17730496453902 },
    { x: 99.8581560283688, y: 67.17730496453902 },
    { x: 96.22695035460993, y: 68.99290780141844 },
    { x: 96.22695035460993, y: 70.80851063829788 },
    { x: 94.41134751773049, y: 70.80851063829788 },
    { x: 94.41134751773049, y: 72.62411347517731 },
    { x: 92.59574468085106, y: 72.62411347517731 },
    { x: 90.78014184397163, y: 72.62411347517731 },
    { x: 90.78014184397163, y: 74.43971631205673 },
    { x: 88.9645390070922, y: 74.43971631205673 },
    { x: 87.14893617021276, y: 76.25531914893617 },
    { x: 85.33333333333333, y: 78.0709219858156 },
    { x: 83.5177304964539, y: 78.0709219858156 },
    { x: 81.70212765957447, y: 78.0709219858156 },
    { x: 79.88652482269504, y: 79.88652482269504 },
    { x: 78.0709219858156, y: 81.70212765957447 },
    { x: 74.43971631205673, y: 81.70212765957447 },
    { x: 72.6241134751773, y: 83.51773049645391 },
    { x: 70.80851063829788, y: 85.33333333333333 },
    { x: 68.99290780141844, y: 85.33333333333333 },
    { x: 67.177304964539, y: 85.33333333333333 },
    { x: 65.36170212765957, y: 85.33333333333333 },
    { x: 63.54609929078014, y: 87.14893617021276 },
    { x: 61.730496453900706, y: 87.14893617021276 },
    { x: 59.91489361702128, y: 87.14893617021276 },
    { x: 58.09929078014184, y: 87.14893617021276 },
    { x: 56.28368794326241, y: 88.9645390070922 },
    { x: 54.46808510638298, y: 88.9645390070922 },
    { x: 54.46808510638298, y: 90.78014184397163 },
    { x: 52.652482269503544, y: 90.78014184397163 },
    { x: 50.836879432624116, y: 90.78014184397163 },
    { x: 49.02127659574468, y: 92.59574468085107 },
    { x: 47.205673758865245, y: 92.59574468085107 },
    { x: 45.39007092198582, y: 92.59574468085107 },
    { x: 43.57446808510638, y: 94.4113475177305 },
    { x: 41.75886524822695, y: 94.4113475177305 },
    { x: 39.94326241134752, y: 94.4113475177305 },
    { x: 38.12765957446808, y: 96.22695035460993 }
  ],
  // Stroke 2
  [
    { x: 52.652482269503544, y: 105.30496453900709 },
    { x: 52.652482269503544, y: 107.12056737588652 },
    { x: 52.652482269503544, y: 108.93617021276596 },
    { x: 52.652482269503544, y: 110.7517730496454 },
    { x: 52.652482269503544, y: 112.56737588652483 },
    { x: 52.652482269503544, y: 114.38297872340426 },
    { x: 52.652482269503544, y: 116.19858156028369 },
    { x: 52.652482269503544, y: 119.82978723404256 },
    { x: 52.652482269503544, y: 123.46099290780143 },
    { x: 52.652482269503544, y: 125.27659574468085 },
    { x: 52.652482269503544, y: 127.09219858156028 },
    { x: 52.652482269503544, y: 128.9078014184397 },
    { x: 52.652482269503544, y: 132.53900709219857 },
    { x: 52.652482269503544, y: 134.354609929078 },
    { x: 52.652482269503544, y: 137.98581560283688 },
    { x: 52.652482269503544, y: 139.80141843971631 },
    { x: 52.652482269503544, y: 143.43262411347519 },
    { x: 52.652482269503544, y: 147.06382978723406 },
    { x: 52.652482269503544, y: 148.87943262411346 },
    { x: 52.652482269503544, y: 152.51063829787233 },
    { x: 52.652482269503544, y: 154.3262411347518 },
    { x: 54.46808510638298, y: 154.3262411347518 },
    { x: 54.46808510638298, y: 157.9574468085106 },
    { x: 54.46808510638298, y: 159.77304964539007 },
    { x: 54.46808510638298, y: 161.58865248226948 },
    { x: 54.46808510638298, y: 163.40425531914894 },
    { x: 54.46808510638298, y: 165.21985815602835 },
    { x: 54.46808510638298, y: 167.03546099290782 },
    { x: 54.46808510638298, y: 168.85106382978722 },
    { x: 54.46808510638298, y: 170.66666666666669 },
    { x: 54.46808510638298, y: 172.4822695035461 },
    { x: 56.28368794326241, y: 174.29787234042556 },
    { x: 56.28368794326241, y: 176.11347517730496 },
    { x: 56.28368794326241, y: 177.92907801418437 },
    { x: 56.28368794326241, y: 179.74468085106383 },
    { x: 56.28368794326241, y: 181.56028368794324 },
    { x: 56.28368794326241, y: 183.3758865248227 },
    { x: 58.09929078014184, y: 185.1914893617021 },
    { x: 58.09929078014184, y: 187.00709219858157 },
    { x: 58.09929078014184, y: 188.82269503546098 },
    { x: 58.09929078014184, y: 190.63829787234044 },
    { x: 58.09929078014184, y: 192.45390070921985 },
    { x: 58.09929078014184, y: 194.26950354609932 },
    { x: 59.91489361702128, y: 196.08510638297872 },
    { x: 59.91489361702128, y: 197.90070921985813 },
    { x: 59.91489361702128, y: 199.7163120567376 },
    { x: 59.91489361702128, y: 201.531914893617 },
    { x: 59.91489361702128, y: 203.34751773049646 },
    { x: 59.91489361702128, y: 205.16312056737587 },
    { x: 59.91489361702128, y: 206.97872340425533 },
    { x: 59.91489361702128, y: 208.79432624113474 },
    { x: 59.91489361702128, y: 212.4255319148936 },
    { x: 61.730496453900706, y: 214.24113475177307 },
    { x: 61.730496453900706, y: 216.05673758865248 },
    { x: 61.730496453900706, y: 219.68794326241135 },
    { x: 61.730496453900706, y: 221.50354609929076 },
    { x: 61.730496453900706, y: 223.31914893617022 },
    { x: 63.54609929078014, y: 225.13475177304963 },
    { x: 63.54609929078014, y: 226.9503546099291 },
    { x: 63.54609929078014, y: 228.7659574468085 },
    { x: 63.54609929078014, y: 230.58156028368796 }
  ],
  // Stroke 3
  [
    { x: 56.28368794326241, y: 121.64539007092199 },
    { x: 58.09929078014184, y: 121.64539007092199 },
    { x: 59.91489361702128, y: 121.64539007092199 },
    { x: 61.730496453900706, y: 121.64539007092199 },
    { x: 63.54609929078014, y: 121.64539007092199 },
    { x: 65.36170212765957, y: 121.64539007092199 },
    { x: 67.177304964539, y: 121.64539007092199 },
    { x: 68.99290780141844, y: 121.64539007092199 },
    { x: 72.6241134751773, y: 119.82978723404256 },
    { x: 76.25531914893617, y: 119.82978723404256 },
    { x: 78.0709219858156, y: 119.82978723404256 },
    { x: 79.88652482269504, y: 119.82978723404256 },
    { x: 81.70212765957447, y: 119.82978723404256 },
    { x: 87.14893617021276, y: 119.82978723404256 },
    { x: 88.9645390070922, y: 119.82978723404256 },
    { x: 90.78014184397163, y: 119.82978723404256 },
    { x: 94.41134751773049, y: 119.82978723404256 },
    { x: 96.22695035460993, y: 119.82978723404256 },
    { x: 98.04255319148936, y: 119.82978723404256 },
    { x: 99.8581560283688, y: 119.82978723404256 },
    { x: 101.67375886524823, y: 119.82978723404256 },
    { x: 103.48936170212765, y: 119.82978723404256 },
    { x: 105.30496453900709, y: 119.82978723404256 },
    { x: 107.12056737588652, y: 119.82978723404256 },
    { x: 110.7517730496454, y: 119.82978723404256 },
    { x: 112.56737588652481, y: 119.82978723404256 },
    { x: 116.19858156028369, y: 119.82978723404256 },
    { x: 118.01418439716312, y: 119.82978723404256 },
    { x: 121.64539007092198, y: 119.82978723404256 },
    { x: 123.46099290780141, y: 119.82978723404256 },
    { x: 125.27659574468085, y: 119.82978723404256 },
    { x: 127.09219858156028, y: 119.82978723404256 },
    { x: 128.9078014184397, y: 119.82978723404256 },
    { x: 130.72340425531914, y: 119.82978723404256 },
    { x: 134.354609929078, y: 118.01418439716312 },
    { x: 136.17021276595744, y: 118.01418439716312 },
    { x: 139.80141843971631, y: 118.01418439716312 },
    { x: 143.43262411347519, y: 118.01418439716312 },
    { x: 145.2482269503546, y: 118.01418439716312 },
    { x: 147.06382978723403, y: 118.01418439716312 },
    { x: 148.87943262411346, y: 116.19858156028369 },
    { x: 150.6950354609929, y: 116.19858156028369 },
    { x: 152.51063829787233, y: 116.19858156028369 },
    { x: 154.32624113475177, y: 116.19858156028369 },
    { x: 156.1418439716312, y: 114.38297872340426 },
    { x: 157.95744680851064, y: 114.38297872340426 },
    { x: 161.5886524822695, y: 114.38297872340426 },
    { x: 163.40425531914894, y: 114.38297872340426 },
    { x: 165.21985815602835, y: 114.38297872340426 },
    { x: 167.0354609929078, y: 114.38297872340426 },
    { x: 168.85106382978722, y: 114.38297872340426 },
    { x: 170.66666666666666, y: 114.38297872340426 },
    { x: 170.66666666666666, y: 112.56737588652483 },
    { x: 172.4822695035461, y: 112.56737588652483 },
    { x: 174.29787234042553, y: 112.56737588652483 },
    { x: 176.11347517730496, y: 112.56737588652483 },
    { x: 177.9290780141844, y: 112.56737588652483 },
    { x: 179.74468085106383, y: 112.56737588652483 },
    { x: 181.56028368794327, y: 112.56737588652483 },
    { x: 183.3758865248227, y: 112.56737588652483 },
    { x: 187.00709219858155, y: 110.7517730496454 },
    { x: 188.82269503546098, y: 110.7517730496454 },
    { x: 190.63829787234042, y: 110.7517730496454 },
    { x: 192.45390070921985, y: 110.7517730496454 },
    { x: 194.2695035460993, y: 110.7517730496454 },
    { x: 196.08510638297872, y: 110.7517730496454 },
    { x: 199.7163120567376, y: 110.7517730496454 },
    { x: 201.53191489361703, y: 110.7517730496454 },
    { x: 203.34751773049646, y: 110.7517730496454 },
    { x: 205.16312056737587, y: 110.7517730496454 },
    { x: 205.16312056737587, y: 108.93617021276596 },
    { x: 206.9787234042553, y: 108.93617021276596 },
    { x: 208.79432624113474, y: 108.93617021276596 },
    { x: 210.60992907801418, y: 108.93617021276596 }
  ],
  // Stroke 4
  [
    { x: 177.9290780141844, y: 118.01418439716312 },
    { x: 177.9290780141844, y: 121.64539007092199 },
    { x: 177.9290780141844, y: 123.46099290780143 },
    { x: 177.9290780141844, y: 125.27659574468085 },
    { x: 177.9290780141844, y: 128.9078014184397 },
    { x: 177.9290780141844, y: 130.72340425531917 },
    { x: 177.9290780141844, y: 132.53900709219857 },
    { x: 177.9290780141844, y: 134.354609929078 },
    { x: 177.9290780141844, y: 136.17021276595744 },
    { x: 176.11347517730496, y: 139.80141843971631 },
    { x: 176.11347517730496, y: 141.61702127659572 },
    { x: 176.11347517730496, y: 145.2482269503546 },
    { x: 174.29787234042553, y: 148.87943262411346 },
    { x: 174.29787234042553, y: 150.69503546099293 },
    { x: 174.29787234042553, y: 154.3262411347518 },
    { x: 174.29787234042553, y: 156.1418439716312 },
    { x: 174.29787234042553, y: 157.9574468085106 },
    { x: 174.29787234042553, y: 161.58865248226948 },
    { x: 172.4822695035461, y: 161.58865248226948 },
    { x: 172.4822695035461, y: 163.40425531914894 },
    { x: 172.4822695035461, y: 165.21985815602835 },
    { x: 172.4822695035461, y: 167.03546099290782 },
    { x: 170.66666666666666, y: 167.03546099290782 },
    { x: 170.66666666666666, y: 170.66666666666669 },
    { x: 170.66666666666666, y: 174.29787234042556 },
    { x: 170.66666666666666, y: 176.11347517730496 },
    { x: 170.66666666666666, y: 177.92907801418437 },
    { x: 170.66666666666666, y: 179.74468085106383 },
    { x: 170.66666666666666, y: 181.56028368794324 },
    { x: 168.85106382978722, y: 183.3758865248227 },
    { x: 168.85106382978722, y: 187.00709219858157 },
    { x: 168.85106382978722, y: 188.82269503546098 },
    { x: 168.85106382978722, y: 192.45390070921985 },
    { x: 168.85106382978722, y: 194.26950354609932 },
    { x: 168.85106382978722, y: 196.08510638297872 },
    { x: 168.85106382978722, y: 197.90070921985813 },
    { x: 168.85106382978722, y: 199.7163120567376 },
    { x: 168.85106382978722, y: 201.531914893617 },
    { x: 168.85106382978722, y: 205.16312056737587 },
    { x: 168.85106382978722, y: 206.97872340425533 },
    { x: 168.85106382978722, y: 208.79432624113474 },
    { x: 168.85106382978722, y: 210.6099290780142 },
    { x: 168.85106382978722, y: 214.24113475177307 },
    { x: 170.66666666666666, y: 216.05673758865248 },
    { x: 170.66666666666666, y: 217.8723404255319 },
    { x: 170.66666666666666, y: 219.68794326241135 },
    { x: 170.66666666666666, y: 221.50354609929076 },
    { x: 170.66666666666666, y: 223.31914893617022 },
    { x: 170.66666666666666, y: 225.13475177304963 },
    { x: 170.66666666666666, y: 226.9503546099291 }
  ],
  // Stroke 5
  [
    { x: 0.0, y: 239.6595744680851 },
    { x: 3.631205673758865, y: 239.6595744680851 },
    { x: 5.446808510638298, y: 239.6595744680851 },
    { x: 7.26241134751773, y: 239.6595744680851 },
    { x: 9.078014184397162, y: 239.6595744680851 },
    { x: 10.893617021276595, y: 239.6595744680851 },
    { x: 14.52482269503546, y: 239.6595744680851 },
    { x: 18.156028368794324, y: 239.6595744680851 },
    { x: 19.97163120567376, y: 239.6595744680851 },
    { x: 23.602836879432623, y: 239.6595744680851 },
    { x: 25.418439716312058, y: 239.6595744680851 },
    { x: 27.23404255319149, y: 239.6595744680851 },
    { x: 29.04964539007092, y: 239.6595744680851 },
    { x: 30.865248226950353, y: 239.6595744680851 },
    { x: 32.680851063829785, y: 239.6595744680851 },
    { x: 34.49645390070922, y: 239.6595744680851 },
    { x: 36.31205673758865, y: 239.6595744680851 },
    { x: 38.12765957446808, y: 239.6595744680851 },
    { x: 39.94326241134752, y: 239.6595744680851 },
    { x: 41.75886524822695, y: 239.6595744680851 },
    { x: 43.57446808510638, y: 239.6595744680851 },
    { x: 45.39007092198582, y: 239.6595744680851 },
    { x: 49.02127659574468, y: 239.6595744680851 },
    { x: 50.836879432624116, y: 239.6595744680851 },
    { x: 52.652482269503544, y: 239.6595744680851 },
    { x: 58.09929078014184, y: 241.47517730496452 },
    { x: 59.91489361702128, y: 241.47517730496452 },
    { x: 63.54609929078014, y: 243.29078014184398 },
    { x: 65.36170212765957, y: 243.29078014184398 },
    { x: 67.177304964539, y: 243.29078014184398 },
    { x: 70.80851063829788, y: 243.29078014184398 },
    { x: 72.6241134751773, y: 243.29078014184398 },
    { x: 74.43971631205673, y: 243.29078014184398 },
    { x: 76.25531914893617, y: 243.29078014184398 },
    { x: 78.0709219858156, y: 243.29078014184398 },
    { x: 79.88652482269504, y: 243.29078014184398 },
    { x: 83.5177304964539, y: 243.29078014184398 },
    { x: 85.33333333333333, y: 243.29078014184398 },
    { x: 87.14893617021276, y: 243.29078014184398 },
    { x: 90.78014184397163, y: 243.29078014184398 },
    { x: 94.41134751773049, y: 243.29078014184398 },
    { x: 96.22695035460993, y: 243.29078014184398 },
    { x: 98.04255319148936, y: 243.29078014184398 },
    { x: 101.67375886524823, y: 243.29078014184398 },
    { x: 103.48936170212765, y: 243.29078014184398 },
    { x: 105.30496453900709, y: 243.29078014184398 },
    { x: 107.12056737588652, y: 243.29078014184398 },
    { x: 108.93617021276596, y: 243.29078014184398 },
    { x: 110.7517730496454, y: 243.29078014184398 },
    { x: 112.56737588652481, y: 243.29078014184398 },
    { x: 114.38297872340425, y: 243.29078014184398 },
    { x: 116.19858156028369, y: 243.29078014184398 },
    { x: 118.01418439716312, y: 243.29078014184398 },
    { x: 119.82978723404256, y: 243.29078014184398 },
    { x: 123.46099290780141, y: 243.29078014184398 },
    { x: 127.09219858156028, y: 243.29078014184398 },
    { x: 130.72340425531914, y: 243.29078014184398 },
    { x: 132.53900709219857, y: 243.29078014184398 },
    { x: 134.354609929078, y: 243.29078014184398 },
    { x: 137.98581560283688, y: 243.29078014184398 },
    { x: 139.80141843971631, y: 243.29078014184398 },
    { x: 143.43262411347519, y: 243.29078014184398 },
    { x: 147.06382978723403, y: 243.29078014184398 },
    { x: 148.87943262411346, y: 243.29078014184398 },
    { x: 150.6950354609929, y: 243.29078014184398 },
    { x: 154.32624113475177, y: 243.29078014184398 },
    { x: 156.1418439716312, y: 243.29078014184398 },
    { x: 157.95744680851064, y: 243.29078014184398 },
    { x: 159.77304964539007, y: 243.29078014184398 },
    { x: 163.40425531914894, y: 243.29078014184398 },
    { x: 167.0354609929078, y: 243.29078014184398 },
    { x: 168.85106382978722, y: 243.29078014184398 },
    { x: 170.66666666666666, y: 243.29078014184398 },
    { x: 174.29787234042553, y: 241.47517730496452 },
    { x: 176.11347517730496, y: 241.47517730496452 },
    { x: 177.9290780141844, y: 241.47517730496452 },
    { x: 181.56028368794327, y: 241.47517730496452 },
    { x: 183.3758865248227, y: 241.47517730496452 },
    { x: 187.00709219858155, y: 241.47517730496452 },
    { x: 190.63829787234042, y: 241.47517730496452 },
    { x: 192.45390070921985, y: 241.47517730496452 },
    { x: 194.2695035460993, y: 239.6595744680851 },
    { x: 196.08510638297872, y: 239.6595744680851 },
    { x: 197.90070921985816, y: 239.6595744680851 },
    { x: 201.53191489361703, y: 239.6595744680851 },
    { x: 203.34751773049646, y: 239.6595744680851 },
    { x: 206.9787234042553, y: 239.6595744680851 },
    { x: 208.79432624113474, y: 239.6595744680851 },
    { x: 210.60992907801418, y: 239.6595744680851 },
    { x: 214.24113475177305, y: 239.6595744680851 },
    { x: 216.05673758865248, y: 237.84397163120565 },
    { x: 217.87234042553192, y: 237.84397163120565 },
    { x: 221.5035460992908, y: 237.84397163120565 },
    { x: 223.3191489361702, y: 237.84397163120565 },
    { x: 226.95035460992906, y: 237.84397163120565 },
    { x: 228.7659574468085, y: 237.84397163120565 },
    { x: 230.58156028368793, y: 237.84397163120565 },
    { x: 232.39716312056737, y: 237.84397163120565 },
    { x: 234.2127659574468, y: 237.84397163120565 },
    { x: 236.02836879432624, y: 237.84397163120565 },
    { x: 239.6595744680851, y: 237.84397163120565 },
    { x: 241.47517730496455, y: 237.84397163120565 },
    { x: 243.29078014184395, y: 237.84397163120565 },
    { x: 245.1063829787234, y: 237.84397163120565 },
    { x: 246.92198581560282, y: 237.84397163120565 },
    { x: 248.73758865248226, y: 237.84397163120565 },
    { x: 250.5531914893617, y: 237.84397163120565 },
    { x: 252.36879432624113, y: 237.84397163120565 },
    { x: 254.18439716312056, y: 237.84397163120565 },
    { x: 256.0, y: 237.84397163120565 }
  ]
];


// 3. FUNKCJA POMOCNICZA DO USTALANIA KOLORU
/**
 * Zwraca kolor kreski na podstawie jej wyniku dokładności (0.0 - 1.0).
 */
const getStrokeColor = (accuracy: number | undefined): string => {
  // Kolor domyślny (przed sprawdzeniem)
  if (accuracy === undefined) {
    return "#1F2937"; // Ciemnoszary
  }

  // 75-100% -> Zielony
  if (accuracy >= 0.60) {
    return "#22C55E"; // green-500
  }

  // 50-75% -> Pomarańczowy
  if (accuracy >= 0.5) {
    return "#F97316"; // orange-500
  }

  // <50% -> Czerwony
  return "#EF4444"; // red-500
};


export default function KanjiCanvas() {
  // 4. ZAKTUALIZUJ TYP STANU
  const [strokes, setStrokes] = useState<Stroke[]>([]);
  const [currentStroke, setCurrentStroke] = useState<number[][]>([]);
  
  // Nowy stan do przechowywania wyników
  const [accuracyResult, setAccuracyResult] = useState<KanjiAccuracyResult | null>(null);

  // Funkcje konwertujące (bez zmian)
  const referencePointsToPath = useCallback((points: Point[]) => {
    if (points.length === 0) return "";
    return points.map((p, i) => (i === 0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`)).join(" ");
  }, []);

  const pointsToPath = useCallback((points: number[][]) => {
    if (points.length === 0) return "";
    return points.map((p, i) => (i === 0 ? `M ${p[0]} ${p[1]}` : `L ${p[0]} ${p[1]}`)).join(" ");
  }, []);

  // Rysowanie (bez zmian)
  const handleGesture = (event: any) => {
    const { x, y } = event.nativeEvent;
    const clampedY = Math.max(0, y);
    const clampedX = Math.max(0, x);
    setCurrentStroke((prev) => [...prev, [clampedX, clampedY]]);
  };

  // Zakończenie kreski (bez zmian)
  const handleEnd = () => {
    if (currentStroke.length > 0) {
      // Zapisujemy kreskę bez 'accuracy' na razie
      setStrokes((prev) => [...prev, { points: currentStroke }]);
      setCurrentStroke([]);
    }
  };

  // 5. ZAKTUALIZUJ `handleClear`
  const handleClear = () => {
    setStrokes([]);
    setCurrentStroke([]);
    setAccuracyResult(null); // Resetuj również wyniki
  };

  const handleUndo = useCallback(() => {
    // Usuń ostatnią kreskę
    setStrokes((prev) => {
      if (prev.length === 0) return []; // Nic do cofnięcia
      
      // Pobierz wszystkie kreski oprócz ostatniej
      const newStrokes = prev.slice(0, -1);
      
      // Wyczyść wyniki dokładności z pozostałych kresek,
      // ponieważ zestaw jest teraz niekompletny/zmieniony.
      // Zostawiamy tylko punkty, usuwając pole 'accuracy'.
      return newStrokes.map(stroke => ({ points: stroke.points }));
    });

    // Zresetuj również ogólny wynik
    setAccuracyResult(null);
  }, []);


  // 6. ZAKTUALIZUJ `checkKanji`
  const checkKanji = async () => { 
  
    try {
      const accessToken = await SecureStore.getItemAsync('accessToken');
      if (!accessToken) {
        console.error("Brak tokenu dostępu.");
        return;
      }
      
      const payload = {
        points: strokes.map(stroke =>
            stroke.points.map(([x, y]) => ({ x, y }))
        )
      };

      console.log("Wysyłanie payloadu:", JSON.stringify(payload));

      const response = await fetch(`${process.env.EXPO_PUBLIC_BACKEND_URL}/test`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify(payload)
      });
  
      if (!response.ok) {
        throw new Error(`Błąd API: ${response.status}`);
      }
  
      const data = await response.json();
      console.log(data)
      if (data) {
        console.log("Otrzymano odpowiedź:", data);
        
        const results: KanjiAccuracyResult = data;
        
        // Zapisz ogólny wynik
        setAccuracyResult(results);

        // Zaktualizuj stan 'strokes', dodając do każdej kreski jej dokładność
        setStrokes(prevStrokes =>
          prevStrokes.map((stroke, index) => ({
            ...stroke,
            // Przypisz dokładność z tablicy 'strokeAccuracies'
            accuracy: results.strokeAccuracies[index] ?? 0, 
          }))
        );

      }
  
    } catch (error) {
      console.error("Błąd podczas wysyłania wiadomości:", error);
    }
  };

  return (
    <GestureHandlerRootView style={styles.container}>
      <View style={styles.headerContainer}>
        <Text style={styles.targetKanji}>七</Text>
        
        {/* BONUS: Wyświetl ogólną dokładność, jeśli jest dostępna */}
        {accuracyResult && (
          <Text style={styles.accuracyText}>
            Ogólna dokładność: {(accuracyResult.overallAccuracy * 100).toFixed(0)}%
          </Text>
        )}
      </View>

      <View style={styles.canvasWrapper}>
        <PanGestureHandler
          onGestureEvent={handleGesture}
          onHandlerStateChange={(event) => {
            if (event.nativeEvent.state === State.END) handleEnd();
          }}
        >
          <View style={styles.canvasContainer}>
            <Svg width="100%" height="100%">
              {/* Siatka (bez zmian) */}
              <Path
                d={`M ${CANVAS_SIZE / 2} 0 L ${CANVAS_SIZE / 2} ${CANVAS_SIZE} M 0 ${CANVAS_SIZE / 2} L ${CANVAS_SIZE} ${CANVAS_SIZE / 2}`}
                stroke="#E5E7EB"
                strokeWidth={1}
              />

              {/* Wzór referencyjny (bez zmian) */}
              {REFERENCE_KANJI_POINTS.map((strokePoints, i) => (
                <Path
                  key={`ref-${i}`}
                  d={referencePointsToPath(strokePoints)}
                  stroke="#D1D5DB"
                  strokeWidth={6}
                  fill="none"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  opacity={0.8}
                />
              ))}

              {/* 7. ZAKTUALIZUJ RENDEROWANIE KRESEK UŻYTKOWNIKA */}
              {strokes.map((stroke, i) => {
                  return (
                    <Path
                      key={i}
                      d={pointsToPath(stroke.points)}
                      // Użyj funkcji `getStrokeColor` na podstawie zapisanej dokładności
                      stroke={getStrokeColor(stroke.accuracy)} 
                      strokeWidth={6}
                      fill="none"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                  );
                }
              )}

              {/* Aktualna kreska użytkownika (bez zmian) */}
              {currentStroke.length > 0 && (
                <Path
                  d={pointsToPath(currentStroke)}
                  stroke="#EF4444" // Nadal czerwona podczas rysowania
                  strokeWidth={6}
                  fill="none"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              )}
            </Svg>
          </View>
        </PanGestureHandler>
      </View>

      {/* Przyciski (bez zmian) */}
      <View style={styles.buttonsContainer}>
        <TouchableOpacity style={[styles.buttonBase, styles.buttonOutline]} onPress={handleClear}>
          <Text style={styles.buttonOutlineText}>Reset</Text>
        </TouchableOpacity>

        <TouchableOpacity style={[styles.buttonBase, styles.buttonOutline]} onPress={handleUndo}>
          <Text style={styles.buttonOutlineText}>Undo</Text>
        </TouchableOpacity>

        <TouchableOpacity style={[styles.buttonBase, styles.buttonOutline]} onPress={checkKanji}>
          <Text style={styles.buttonOutlineText}>Check</Text>
        </TouchableOpacity>
      </View>
    </GestureHandlerRootView>
  );
}

const styles = StyleSheet.create({
  // ... (Większość stylów bez zmian)
  container: {
    flex: 1,
    backgroundColor: "#F9FAFB",
    padding: 20,
    alignItems: "center",
    justifyContent: "space-between",
  },
  headerContainer: {
    alignItems: "center",
    marginVertical: 20,
  },
  targetKanji: {
    fontSize: 72,
    fontWeight: "700",
    color: "#1F2937",
  },
  // NOWY STYL dla tekstu dokładności
  accuracyText: {
    fontSize: 18,
    fontWeight: "600",
    color: "#3B82F6", // niebieski-500
    marginTop: 8,
  },
  targetKanjiSubtitle: {
    fontSize: 16,
    color: "#6B7280",
    fontWeight: "500",
  },
  canvasWrapper: {
    width: CANVAS_SIZE,
    height: CANVAS_SIZE,
    borderRadius: 12,
    borderWidth: 2,
    borderColor: "#E5E7EB",
    backgroundColor: "#fff",
    overflow: "hidden",
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 5,
  },
  canvasContainer: {
    flex: 1,
  },
  buttonsContainer: {
    flexDirection: "row",
    justifyContent: "space-around",
    width: "100%",
    paddingHorizontal: 10,
    marginTop: 30,
    marginBottom: 20,
    gap: 10,
  },
  buttonBase: {
    flex: 1,
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "center",
    paddingVertical: 12,
    paddingHorizontal: 8,
    borderRadius: 8,
    height: 50,
    gap: 6,
  },
  buttonPrimary: {
    backgroundColor: "#3B82F6",
    shadowColor: "#1D4ED8",
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 5,
    elevation: 8,
  },
  buttonPrimaryText: {
    color: "#fff",
    fontSize: 14,
    fontWeight: "600",
  },
  buttonOutline: {
    backgroundColor: "#fff",
    borderWidth: 1,
    borderColor: "#D1D5DB",
  },
  buttonOutlineText: {
    color: "#6B7280",
    fontSize: 14,
    fontWeight: "600",
  },
});